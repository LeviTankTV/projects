package GameV2;

import java.util.ArrayList;
import java.util.List;
import java.util.Random;

public class GhostArena extends Room {
    private GhostFactory ghostFactory;
    private Random random;
    private final List<String> roomDescriptions;

    public GhostArena(Player player) {
        super();
        ghostFactory = new GhostFactory();
        random = new Random();
        generateGhosts(player);
        roomDescriptions = initializeRoomDescriptions();
    }

    private static final String FOUNTAIN_ART = """
            \033[0;36m
                                  .-.
                     heehee      /aa \\_
                               __\\-  / )                 .-.
                     .-.      (__/    /        haha    _/oo \\
                   _/ ..\\       /     \\               ( \\v  /__
                  ( \\  u/__    /       \\__             \\/   ___)
                   \\    \\__)   \\_.-._._   )  .-.       /     \\
                   /     \\             `-`  / ee\\_    /       \\_
                __/       \\               __\\  o/ )   \\_.-.__   )
               (   _._.-._/     hoho     (___   \\/           '-'
                '-'                        /     \\
                                         _/       \\    teehee
                                        (   __.-._/
            \033[0m
            """;

    private void generateGhosts(Player player) {
        // 50% chance to spawn NecroMage
        if (random.nextDouble() < 0.5) {
            addEnemy(new NecroMage("Некромаг", player.getLevel()));
        }

        // Spawn 1-4 ghosts
        int numGhosts = random.nextInt(4) + 1;
        for (int i = 0; i < numGhosts; i++) {
            addEnemy(ghostFactory.createGhost(player));
        }
    }

    private List<String> initializeRoomDescriptions() {
        List<String> descriptions = new ArrayList<>();
        descriptions.add("Вы входите в разрушенный зал, где некогда проводились королевские приёмы. Теперь здесь лишь пыль и паутина.");
        descriptions.add("Перед вами открывается сгнившая библиотека. Древние фолианты превратились в труху, а воздух пропитан запахом плесени.");
        descriptions.add("Вы оказываетесь в бывшей тронной зале. Испорченные стены, некогда украшенные золотом, теперь покрыты плесенью и трещинами.");
        descriptions.add("Бальный зал встречает вас зловещей тишиной. Разбитые зеркала и порванные гобелены напоминают о былом величии.");
        descriptions.add("Вы входите в древнюю часовню. Разбитые витражи и покосившиеся скамьи создают гнетущую атмосферу.");
        descriptions.add("Королевская оружейная предстает перед вами в плачевном состоянии. Проржавевшие доспехи безмолвно охраняют руины.");
        descriptions.add("Вы попадаете в разрушенную галерею портретов. Истлевшие картины едва различимы на покрытых плесенью стенах.");
        descriptions.add("Вы входите в исчезающий зал, где двигались таинственные тени. Тишина окутала пространство, и только шорохи от пыли напоминают о прошлом.");
        descriptions.add("Перед вами открывается древний коридор, покрытый толстым слоем пыли. Стены исписаны странными знаками, забытыми временем.");
        descriptions.add("Вы оказываетесь в зале балов, где когда-то звучала музыка. Сейчас лишь ветер напоминает о праздниках.");
        descriptions.add("Вы входите в эхо утраченного величия. Окна, заколоченные досками, пропускают лишь тусклый свет.");
        descriptions.add("Внемлите запаху затхлости, когда вы входите в старую кухню. Разбитая утварь и пыльные полки создают атмосферу заброшенности.");
        descriptions.add("Взгляд ваш падает на потемневший альков. Когда-то здесь резвилась молодежь, а теперь это место стало хранилищем призраков.");
        descriptions.add("Коридор, по которому вы идете, обвязан паутиной. Каждый шаг звучит как призыв к давно забытым душам.");
        descriptions.add("Вы попали в старый архив, где зловещие стенды хранят забытые тайны. Аромат гниения заполняет воздух.");
        descriptions.add("Вы входите в разоруженное святилище. Осколки когда-то священных предметов лежат на настоящем дне забвения.");
        descriptions.add("С трудом распознаваемая лестница ведет вас в темные глубины замка. Каждая ступенька кричит о забытой истории.");
        descriptions.add("Вы оказываетесь в зале приемов, где однажды раздавался смех. Теперь тут лишь мрак и тишина, что давит на душу.");
        descriptions.add("Проходя через разрушенные дверные проемы, вы чувствуете, как оживают воспоминания давно ушедших времен.");
        descriptions.add("В старом зале для гостей разбросаны скамьи с покорёженной обивкой. Они напоминают о былой роскоши.");
        descriptions.add("Вы входите в саркофаг памяти — зал, наполненный затхлым воздухом и обрывками историй.");
        descriptions.add("Комната, казалось бы, замерла во времени. Старые компоты и вино застыли в неподвижности.");
        descriptions.add("Вы проходите в длинный коридор, где выцветшие портреты семейства смотрят на вас с покойным интересом.");
        descriptions.add("Аромат заброшенных цветов встречает вас в саду, где природа возвратила себе своё место.");
        descriptions.add("Вы входите в библиотеку с полками, полными невидимых знаний, покрытых слоем вековой пыли.");
        descriptions.add("Проходя через ветхие двери, вы сталкиваетесь с призрачным видением былых тронных приемов.");
        descriptions.add("Глубокая темнота окутывает вас, когда вы входите в подземные камеры, где оставили свои жизни бездушные проклятые.");
        descriptions.add("Вы находитесь в коллекции предметов, когда-то любимых. Теперь они пылятся, ожидая своего часа.");
        descriptions.add("Вы попадаете в великолепную, но запущенную кладовую — здесь заблудились тени былого благосостояния.");
        descriptions.add("Перед вами стол, заполонённый несостоявшимися мечтами. Он покрыт пылью и лишен здешнего тепла.");
        descriptions.add("Вы входите в мрачное помещение, где звуки радуются лишь тому, что остались на земле.");
        descriptions.add("Сквозь треснувшие стены пробивается лишь ослепляющий свет — свет, который скрывает печальную правду.");
        descriptions.add("Вы пересекаете порог заброшенной капеллы. Пепел молитв витается в воздухе, и лишь тени помнят.");
        descriptions.add("Пересеките старинный порог, и вы окажетесь в опустошённом зале, где когда-то проходили величественные собрания.");
        descriptions.add("Вы попадаете в святая святых, где отголоски молитв сливаются с тишиной, создавая неописуемую гармонию.");
        descriptions.add("Вы находитесь в древнем туалете, где отразилась бессмыслица жизни, а вдохновение было выброшено.");
        descriptions.add("Каменные плиты издают звук, подобный невидимым слезам, когда вы ступаете внутрь мрачного зала.");
        descriptions.add("Взгляд ваш падает на пустую тронную нишу, так и не сделавшую своего выбора — остаться или уйти.");
        descriptions.add("Как только вы входите, ощущение времени уходит, оставляя только призраков воспоминаний.");
        descriptions.add("Вы попадаете в небольшой зал с запущенной планировкой. Здесь витают истории покинутых душ.");
        descriptions.add("Ветра истории обрываются, когда вы проходите в коридор — мрачный и пустынный, словно забытый памятник.");
        descriptions.add("Вы оказываетесь в святая святых, покрытом пылью и записями столь давно похороненных секретов.");
        descriptions.add("Вы входите в бывшую оранжерею, где природа вновь пытается вернуть себе утраченное пространство.");
        descriptions.add("Песчиски лет находят свой путь в ваших венах, когда вы пересекаете эту древнюю сводчатую галерею.");
        descriptions.add("Вы погружаетесь в тишину, когда оказываетесь в центре этого мрачного замкового чертога.");
        descriptions.add("Вы входите в тёмный туннель, ведущий в непонятное. В воздухе витает чувство неизведанности.");
        descriptions.add("Вы ступаете на каменные плиты, которые, казалось бы, хранят в себе заброшенные молитвы.");
        descriptions.add("Каждый шаг по этому древнему пути отзывается в вашем сердце, как где-то вдали мирится с самим собой.");
        descriptions.add("Вы попадаете в заброшенное помещение, где остались лишь острые воспоминания о прошлом.");
        descriptions.add("Помещение окутано тёмной атмосферой, здесь даже свет кажется неприветливым и чуждым.");
        descriptions.add("Вы входите в мрачную залу, где лишенные времени тени оживают в другом измерении.");
        descriptions.add("Вы оказываетесь в давно заброшенной гостиной, где печальные призраки некогда весёлых вечеринок создают зловещую атмосферу.");
        descriptions.add("Сквозь трещины в стенах слышатся шепоты заблудших, а пустота этого места убивает любые надежды.");
        descriptions.add("Вы входите в покинутый кабинет, наполненный призрачными воспоминаниями. Кажется, время остановилось на этом месте.");
        descriptions.add("Песчаные часы, застывшие в своём течении, напоминают о том, как мгновения терялись в бездне забвения.");
        descriptions.add("Классическая комната полна старинной мебели, которую охраняют призраки давно ушедших владельцев.");
        descriptions.add("Вы проходите мимо старого рояля, из которого слышны мелодии, вызванные тоской оставшихся душ.");
        descriptions.add("Каждая плита этого пола пронизана эхом ссор и грёз, оставленных в тени по мере ухода жильцов.");
        descriptions.add("Ошеломляющее молчание здесь пронзает ваше сердце, как если бы само место было полным сожалений.");
        descriptions.add("Вы обнаруживаете зал, где некогда собирались семьи; теперь только тени их смеха блуждают в пустоте.");
        descriptions.add("Призрачные фигуры в полутени напоминают о тех, кто когда-то звал этот замок домом, пока не остались лишь кости воспоминаний.");
        descriptions.add("Проходя через окна, заколоченные досками, вы чувствуете холодный ветер, приносящий с собой печальные истории.");
        descriptions.add("В этом коридоре когда-то восхищали красотой картины, но теперь они лишь напоминания о потерянных душах.");
        descriptions.add("Вы попадаете в пустую комнату, где блуждают воспоминания о неоднократно прошедших праздниках и банкетах.");
        descriptions.add("Тени скользят вдоль стен, когда вы охватываете печальный фон невероятных историй, скрывающихся здесь.");
        descriptions.add("День, когда замок стал пустым, остаётся неуклонно на устах призраков, словно они ждут своего часа.");
        descriptions.add("Ветры завывают в холлах, и вам кажется, будто слышите улыбки, потерянные в этом пространстве.");
        descriptions.add("Комната, полная таинственных артефактов, утопает в тишине, где спят заброшенные воспоминания.");
        descriptions.add("Сажаемые на скрипучие стулья, вы чувствуете, как незримые глаза следят за вами с невиданными гранями.");
        descriptions.add("Вы заглядываете в сердцевину этого пасторального места, оставаясь в одиночестве среди призрачных кипарисов.");
        descriptions.add("Эхо шагов заполняет пустые залы, создавая иллюзию присутствия; здесь всё настраивает вас на меланхолию.");
        descriptions.add("Вы находите бумаги с длинными историями, которые как будто рассказывают о том, кем вы могли бы быть.");
        descriptions.add("Каждая комната хранит свои истории и печали, пронзённые светом зданий, но теперь путь в тень.");
        descriptions.add("Призраки, невидимые и искренние, собираются в тени, чтобы рассказать наличие, которое не возможно увидеть.");
        descriptions.add("Вы оказываетесь в зале, где отголоски голосов до сих пор резонируют в тишине, нанизывая свои обрывки на время.");
        descriptions.add("Следы шагов ведут вас в пустую обитель; кажется, здесь когда-то собиралась жизнь, которая теперь перестала существовать.");
        descriptions.add("Вы слышите душераздирающие воинственные выкрики; призраки остаются здесь, жаждущие справедливости за своё горе.");
        descriptions.add("Двери распахиваются сами собой, словно кто-то пытается призвать вас в мир забытых надежд.");
        descriptions.add("Каждый шкаф здесь кажется населённым духами, которые потом сами растворяются в молчании, оставив лишь шёпот.");
        descriptions.add("Первая палата забытий прокладывает вам путь через потенциальное очищение, запечатанное в старых страницах.");
        descriptions.add("Сквозь зияющие окна вы видите хороводы теней, танцующих на пустых стульях, когда-то издававших смех.");
        descriptions.add("Вы чувствуете температуру, меняющуюся с холода, проходя в зал, где духи искали утешение с губами времени.");
        descriptions.add("Проклятие этого места уверяет вас, что даже самые простые эмоции теперь стали частью руин.");
        descriptions.add("По мере вашего продвижения вглубь замка, голоса неотвязно манят вас назад, жаждущие общения.");
        descriptions.add("Прошлое здесь как бы искривлено, позволяя вам видеть только призрачные образы, но можно почувствовать живое дыхание.");
        descriptions.add("Сложенные книги на полках улыбаются вам каждым шрифтом, сделанным дыханием разу о горькие надежды.");
        descriptions.add("Вы выходите на консоль окна, вглядываясь в окрествление света и теней, на которых танцуют призраки.");
        descriptions.add("Тишина здесь глуха, но в ней скрываются неотправленные письма о любви и несчастьях, оставленных без ответа.");
        descriptions.add("Тени этой комнаты не знают покоя; они собираются, как бы показывая вам величие своего падения.");
        descriptions.add("Тиснение старинного матраса чувствуется в воздухе, пробуждая ностальгию о былых уютных ночах.");
        descriptions.add("Вы находите старый умывальник, где временные капли воды запечатлены в тысячах историй, остающихся без внимания.");
        descriptions.add("Сильный холод ощущается в этом пространстве, где и сама архитектура кажется завуалированной печалью.");
        descriptions.add("Забытые ритмы приходят и уходят, когда вы проходите мимо трона, когда-то занимавшего величие.");
        descriptions.add("Место, где слилось много жизней, опять стало пространством, где лишь души помнят свои имена.");
        descriptions.add("Вы слышите ветер, как будто он сам рассказывает историю опустошения и потерь, оставленных здесь душами.");
        descriptions.add("Возможно, это место более живое, чем вы подозреваете; у него есть истории, которые нуждаются в слушателе.");
        descriptions.add("Старое окно, через которое просачивается свет, слегка мерцает; кажется, оно хранит узы с давно ушедшими викторианцами.");
        descriptions.add("Вы проходите мимо старинного зеркала, в котором, кажется, отражаются не только ваши черты, но и призрачные лица.");
        descriptions.add("Отголоски шагов, слышимые в пустом холле, напоминают о тех днях, когда здесь кипела жизнь и звук смеха.");
        descriptions.add("Вы останавливаетесь в маленькой библиотеке с запылёнными книгами, полными тайн, ожидающими разоблачения.");
        descriptions.add("На стенах коридора висят пожелтевшие портреты. Их глаза следят за вами, будто переживают ваш каждый шаг.");
        descriptions.add("Вы прислоняетесь к стене, и она кажется живой, как будто дышит воспоминаниями заблудших душ.");
        descriptions.add("В воздухе царит сладковатый запах устаревших цветочных композиций, напоминая о торжествах, прошедших давным-давно.");
        descriptions.add("Вы находите пыльный граммофон, из которого слышен треск старой мелодии, пробуждающий ностальгию.");
        descriptions.add("Скрытые в углах комнаты шорохи напоминают о том, что присутствие призраков здесь всё ещё ощутимо.");
        descriptions.add("Каждый шаг по древним половицам вызывает эхо, аналогичное молчаливому разговору между призраками.");
        descriptions.add("Вы выходите на балкон, где ветер шепчет о забытых клятвах, раздавая сообщения из далёкого прошедшего.");
        descriptions.add("Наполовину разрушенная лестница ведёт на чердак, где призраки забираются, оставляя тайны для усопших.");
        descriptions.add("Сквозь полуразрушенные стены вы видите прогулочные дорожки, по которым когда-то шествовали счастливые лица.");
        descriptions.add("Старый скрипучий диван стоит в углу, на нём остаются лишь забытые сны и оставшиеся воспоминания о любви.");
        descriptions.add("Вы замечаете потрёпанные игрушки, оставленные детьми, которые теперь скитаются как призраки в ребенке.");
        descriptions.add("Становится очевидным, что каждая комната скрывает не просто физические вещи, но и переживания жителей.");
        descriptions.add("Вы проходите мимо старинного буфета, который, кажется, хранил тривиальные секреты своих владельцев.");
        descriptions.add("Тайный проход, смутно освещённый переливами теней, указывает на ранее неоткрытые истории дома.");
        descriptions.add("Звуки шёпота доносятся из-за двери, словно духи скучают о жизненных радостях, которые миновали их.");
        descriptions.add("Сквозь запотевшую витрину вы замечаете старые платья, которые висели здесь, как тени тосковавших женщин.");
        descriptions.add("Старый камин, застывший в тишине, хранит пламя неоплаканной памяти о тех, кто когда-то сидел возле него.");
        descriptions.add("Пробираясь через пустые комнаты, вы чувствуете, как тоска её обитателей проникает в вашу душу.");
        descriptions.add("На карты этого места нанесены следы каждого, кто когда-либо звал его домом, придавая ему уникальную ауру.");
        descriptions.add("Вы касаетесь холодных стен, и каждая трещина шепчет вам откровения, хранящиеся на грани забвения.");
        descriptions.add("Дверь, занятая пылью, открывается с трудом, как будто охраняет тайну, которую просто нельзя забыть.");
        descriptions.add("Тишина пылает вокруг, как будто это пространство стало уязвимым к чувствам, бродящим в воздухе.");
        descriptions.add("Каждая вещь в этом месте, казалось бы, скрывает свою историю; даже самый простой предмет полон жизни.");
        descriptions.add("Вы замечаете, что фоторамки окружены пылью, но их содержимое может рассказать о целых поколениях.");
        descriptions.add("Стены впитывают в себя столетия тоски, и это место становится локусом неподвластной вспоминанию печали.");
        descriptions.add("В этом заброшенном месте вы чувствуете присутствие друзей, которые когда-то провели здесь множество дней.");

        return descriptions;
    }

    private void handleGraveInteraction(Game game, Player player) {
        if (random.nextDouble() < 0.99) {
            List<String> availableGraves = new ArrayList<>();

            if (!game.isPutFlowerAtKingGrave() && player.getInventory().getItems().stream().anyMatch(item -> item instanceof Orchid))
                availableGraves.add("King");
            if (!game.isPutFlowerAtQueenGrave() && player.getInventory().getItems().stream().anyMatch(item -> item instanceof Daisy))
                availableGraves.add("Queen");
            if (!game.isPutFlowerAtPrinceGrave() && player.getInventory().getItems().stream().anyMatch(item -> item instanceof Tulip))
                availableGraves.add("Prince");
            if (!game.isPutFlowerAtPrincessGrave() && player.getInventory().getItems().stream().anyMatch(item -> item instanceof Rose))
                availableGraves.add("Princess");

            if (!availableGraves.isEmpty()) {
                String selectedGrave = availableGraves.get(random.nextInt(availableGraves.size()));
                handleSpecificGrave(game, player, selectedGrave);
            }
        }
    }

    private void handleSpecificGrave(Game game, Player player, String graveType) {
        switch (graveType) {
            case "King":
                System.out.println("Вы видите могилу Короля.");
                Orchid orchid = (Orchid) player.getInventory().getItems().stream()
                        .filter(item -> item instanceof Orchid)
                        .findFirst()
                        .orElse(null);
                if (orchid != null) {
                    System.out.println("Вы кладете орхидею на могилу Короля.");
                    player.getInventory().getItems().remove(orchid);
                    game.setPutFlowerAtKingGrave(true);
                } else {
                    System.out.println("Вы печально смотрите на могилу Короля.");
                }
                break;
            case "Queen":
                System.out.println("Вы видите могилу Королевы.");
                Daisy daisy = (Daisy) player.getInventory().getItems().stream()
                        .filter(item -> item instanceof Daisy)
                        .findFirst()
                        .orElse(null);
                if (daisy != null) {
                    System.out.println("Вы кладете маргаритку на могилу Королевы.");
                    player.getInventory().getItems().remove(daisy);
                    game.setPutFlowerAtQueenGrave(true);
                } else {
                    System.out.println("Вы печально смотрите на могилу Королевы.");
                }
                break;
            case "Prince":
                System.out.println("Вы видите могилу Принца.");
                Tulip tulip = (Tulip) player.getInventory().getItems().stream()
                        .filter(item -> item instanceof Tulip)
                        .findFirst()
                        .orElse(null);
                if (tulip != null) {
                    System.out.println("Вы кладете тюльпан на могилу Принца.");
                    player.getInventory().getItems().remove(tulip);
                    game.setPutFlowerAtPrinceGrave(true);
                } else {
                    System.out.println("Вы печально смотрите на могилу Принца.");
                }
                break;
            case "Princess":
                System.out.println("Вы видите могилу Принцессы.");
                Rose rose = (Rose) player.getInventory().getItems().stream()
                        .filter(item -> item instanceof Rose)
                        .findFirst()
                        .orElse(null);
                if (rose != null) {
                    System.out.println("Вы кладете розу на могилу Принцессы.");
                    player.getInventory().getItems().remove(rose);
                    game.setPutFlowerAtPrincessGrave(true);
                } else {
                    System.out.println("Вы печально смотрите на могилу Принцессы.");
                }
                break;
        }
    }

    @Override
    public void playerTurn(Game game, Room room) {
        String randomDescription = roomDescriptions.get(random.nextInt(roomDescriptions.size()));
        System.out.println(randomDescription);

        if (hasEnemies()) {
            System.out.println(FOUNTAIN_ART);
            System.out.println("Вокруг вас материализуются призрачные сущности...");
            handleCombat(game, this);
        } else {
            handleGraveInteraction(game, game.getPlayer());
            handleEmptyRoom(game, room);
        }
    }
}